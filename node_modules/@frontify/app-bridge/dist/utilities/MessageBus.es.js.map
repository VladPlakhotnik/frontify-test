{"version":3,"file":"MessageBus.es.js","sources":["../../src/utilities/MessageBus.ts"],"sourcesContent":["/* (c) Copyright Frontify Ltd., all rights reserved. */\n\nimport { InitializationError, TimeoutReachedError } from '../errors';\nimport { SUBSCRIBE_TIMEOUT } from './subscribe';\nimport { generateRandomString } from './hash';\n\nexport interface IMessageBus {\n    post(message: { parameter: unknown }): unknown;\n}\n\nexport class MessageBus implements IMessageBus {\n    private messageBucket: {\n        message: unknown;\n        token: string;\n        resolve: (value: unknown) => void;\n    }[] = [];\n\n    constructor(private port: MessagePort) {\n        this.port.onmessage = (event) => {\n            const { token } = event.data;\n            const messageIndex = this.messageBucket.findIndex((item) => item.token === token);\n            if (messageIndex > -1) {\n                const message = this.messageBucket.splice(messageIndex, 1)[0];\n                message.resolve(event.data.message);\n            }\n        };\n    }\n\n    public post(message: unknown) {\n        return new Promise((resolve, reject) => {\n            const token = generateRandomString();\n\n            this.messageBucket.push({ message, resolve, token });\n            this.port.postMessage({ message, token });\n\n            setTimeout(() => {\n                reject(new TimeoutReachedError('operation'));\n            }, SUBSCRIBE_TIMEOUT * 10);\n        });\n    }\n}\n\nexport class ErrorMessageBus implements IMessageBus {\n    post() {\n        throw new InitializationError('First use await platformApp.dispatch({ name: \"openConnection\" })');\n    }\n}\n"],"names":["MessageBus","port","event","token","messageIndex","item","message","resolve","reject","generateRandomString","TimeoutReachedError","SUBSCRIBE_TIMEOUT","ErrorMessageBus","InitializationError"],"mappings":";;;;AAUO,MAAMA,EAAkC;AAAA,EAO3C,YAAoBC,GAAmB;AAAnB,SAAA,OAAAA,GANpB,KAAQ,gBAIF,IAGG,KAAA,KAAK,YAAY,CAACC,MAAU;AACvB,YAAA,EAAE,OAAAC,EAAM,IAAID,EAAM,MAClBE,IAAe,KAAK,cAAc,UAAU,CAACC,MAASA,EAAK,UAAUF,CAAK;AAChF,MAAIC,IAAe,MACC,KAAK,cAAc,OAAOA,GAAc,CAAC,EAAE,CAAC,EACpD,QAAQF,EAAM,KAAK,OAAO;AAAA,IACtC;AAAA,EAER;AAAA,EAEO,KAAKI,GAAkB;AAC1B,WAAO,IAAI,QAAQ,CAACC,GAASC,MAAW;AACpC,YAAML,IAAQM;AAEd,WAAK,cAAc,KAAK,EAAE,SAAAH,GAAS,SAAAC,GAAS,OAAAJ,GAAO,GACnD,KAAK,KAAK,YAAY,EAAE,SAAAG,GAAS,OAAAH,EAAO,CAAA,GAExC,WAAW,MAAM;AACN,QAAAK,EAAA,IAAIE,EAAoB,WAAW,CAAC;AAAA,MAAA,GAC5CC,IAAoB,EAAE;AAAA,IAAA,CAC5B;AAAA,EACL;AACJ;AAEO,MAAMC,EAAuC;AAAA,EAChD,OAAO;AACG,UAAA,IAAIC,EAAoB,kEAAkE;AAAA,EACpG;AACJ;"}